<%- include("../layouts/admin_header.ejs") %>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Management</title>
  <style>
    .table-container {
      margin: 20px 0;
    }

    .order-details {
      margin-top: 20px;
    }

    .status-select {
      width: 150px;
    }

    .address-column {
      width: 250px; /* Adjust the width as needed */
      word-wrap: break-word; /* Ensures long addresses wrap within the cell */
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="mt-5">Order Management</h1>
    <div class="table-container">
      <table class="table table-bordered table-hover">
        <thead class="thead-dark">
          <tr>
            <th>Order ID</th>
            <th>User</th>
            <th class="address-column">Shipping Address</th>
            <th>Total Price</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach(order => { %>
          <tr>
            <td><%= order._id %></td>
            <td>
              <% if(order.userId) { %>
                <%= order.userId.username %>
              <% } else { %>
                N/A
              <% } %>
            </td>
            <td class="address-column">
              <% 
                const address = order.userId && order.userId.addresses 
                                ? order.userId.addresses.find(address => address._id.equals(order.shippingAddressId))
                                : null;
                if (address) { %>
                <%= address.firstName %> <%= address.lastName %>, 
                <%= address.address1 %>, 
                <%= address.city %>, 
                <%= address.state %> 
                <%= address.zip %>
              <% } else { %>
                N/A
              <% } %>
            </td>
            <td>$<%= order.totalPrice %></td>
            <td>
              <select class="status-select form-control" onchange="updateOrderStatus('<%= order._id %>', this.value)">
                <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
              </select>
            </td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="viewOrderDetails('<%= order._id %>')">View</button>
              <button class="btn btn-danger btn-sm" onclick="deleteOrder('<%= order._id %>')">Delete</button>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <div class="order-details" id="orderDetails" style="display: none;">
      <!-- Order details will be loaded here -->
    </div>
  </div>

  <script>
    function updateOrderStatus(orderId, status) {
      fetch(`/admin/update-order-status`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ orderId, status }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.message === 'Order status updated successfully') {
          alert('Order status updated successfully');
        } else {
          console.error('Error updating order status');
        }
      })
      .catch(error => console.error('Error:', error));
    }

    function viewOrderDetails(orderId) {
      fetch(`/admin/view-order-details/${orderId}`)
      .then(response => response.json())
      .then(data => {
        const orderDetails = document.getElementById('orderDetails');
        orderDetails.innerHTML = `
          <h2>Order ID: ${data._id}</h2>
          <p>User: ${data.userId ? data.userId.username : 'N/A'}</p>
          <p>Shipping Address: ${data.shippingAddress}</p>
          <p>Total Price: $${data.totalPrice}</p>
          <p>Status: ${data.status}</p>
          <h3>Products:</h3>
          <ul>
            ${data.products.map(product => `<li>${product.name} - Quantity: ${product.quantity}</li>`).join('')}
          </ul>
        `;
        orderDetails.style.display = 'block';
      })
      .catch(error => console.error('Error:', error));
    }

    function deleteOrder(orderId) {
      fetch(`/admin/delete-order`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ orderId }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.message === 'Order deleted successfully') {
          location.reload(); // Reload the page to reflect the deletion
        } else {
          console.error('Error deleting order');
        }
      })
      .catch(error => console.error('Error:', error));
    }
  </script>
</body>

</html>





<%- include("../layouts/admin_footer.ejs") %>

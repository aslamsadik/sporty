<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="/user_assets/css/main.css">
  <style>
    /* Add your styles here */
    body {
      font-family: "Arial", sans-serif;
      background-color: #f8f9fa;
      padding-top: 50px;
    }
    .container {
      max-width: 1200px;
    }
    .coupon-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
    }
    .coupon-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      transition: all 0.3s ease;
    }
    .coupon-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .coupon-info {
      flex: 1;
    }
    .coupon-code {
      font-size: 1rem;
      font-weight: bold;
      color: #333;
    }
    .coupon-discount {
      font-size: 0.9rem;
      color: #28a745;
    }
    .coupon-expiry {
      font-size: 0.8rem;
      color: #888;
    }
    .btn-outline-primary {
      font-size: 0.8rem;
      padding: 5px 10px;
    }
    .checkout-row {
      display: flex;
    }
    .content-section {
      flex: 1;
    }
    .summary-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center">Checkout</h2>

    <% if (message) { %>
    <div class="alert alert-<%= messageType %>"><%= message %></div>
    <% } %>

    <!-- Separate form for applying coupon -->
    <form id="applyCouponForm" method="POST" action="/apply-coupon">
      <div class="coupon-container">
        <h5>Apply Coupon</h5>
        <% if (coupons && coupons.length > 0) { %>
            <% coupons.forEach(coupon => { %>
                <div class="coupon-item">
                    <div class="coupon-info">
                        <div class="coupon-code">Code: <%= coupon.code %></div>
                        <div class="coupon-discount">Discount: ₹<%= coupon.discountValue %></div>
                        <div class="coupon-expiry">
                            Expiry: <%= new Date(coupon.expirationDate).toLocaleDateString() %>
                        </div>
                    </div>
                    <!-- Apply button now submits the form with the selected coupon code -->
                    <button type="button" class="btn btn-outline-primary apply-coupon-button" 
                    data-coupon-code="<%= coupon.code %>">Apply</button>
                </div>
            <% }) %>
        <% } else { %>
            <p>No coupons available.</p>
        <% } %>
    </div>
    
      
      <!-- Hidden input fields to hold the selected coupon code, discount amount, and final amount -->
      <input type="hidden" name="couponCode" id="couponCodeInput">
      <input type="hidden" name="discountAmount" id="discountAmountInput">
      <input type="hidden" name="finalAmount" id="finalAmountInput">
    </form>

    <!-- Form for placing the order -->
    <form id="placeOrderForm" action="/place-order" method="POST">
      <input type="hidden" name="discountAmount" id="discountAmount" value="<%= discountAmount %>">
      <input type="hidden" name="couponCode" id="couponCode" value="<%= appliedCouponCode || '' %>">
      <input type="hidden" name="paymentMethod" id="paymentMethod" value="COD"> <!-- Example for COD -->
      <input type="hidden" name="finalAmount" id="finalAmount" value="<%= finalAmount %>"> <!-- Hidden field for final amount -->
      
      <div class="checkout-row">
        <div class="content-section">
          <h4>Shipping Address</h4>
          <% if (user && user.addresses && user.addresses.length > 0) { %>
            <% user.addresses.forEach((address, index) => { %>
              <div class="address-card <%= index === 0 ? 'active' : '' %>">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="shippingAddressId"
                    id="address<%= index %>"
                    value="<%= address._id %>"
                    <%= index === 0 ? 'checked' : '' %>
                  />
                  <label class="form-check-label" for="address<%= index %>">
                    <%= address.firstName %> <%= address.lastName %><br />
                    <%= address.address1 %> <%= address.address2 %><br />
                    <%= address.city %>, <%= address.state %> <%= address.zip %><br />
                    <%= address.phone %><br />
                    <%= address.email %>
                  </label>
                </div>
                <div class="address-actions">
                  <a href="/profile/edit-address/<%= address._id %>" class="btn btn-secondary btn-sm">Edit</a>
                </div>
              </div>
            <% }) %>
            <a href="/profile/add-addressPage" class="btn btn-primary mt-3">Add Address</a>
          <% } else { %>
            <p>No addresses found.</p>
            <a href="/profile/add-addressPage" class="btn btn-primary">Add Address</a>
          <% } %>
          
          <h4 class="mt-4">Payment Method</h4>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="wallet" value="wallet">
            <label class="form-check-label" for="wallet">Wallet</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="Cash on Delivery">
            <label class="form-check-label" for="cashOnDelivery">Cash on Delivery</label>
          </div>

          <button type="button" class="btn btn-primary btn-lg btn-block mt-4" id="razorpayButton">Pay with Razorpay</button>
        </div>

        <div class="summary-section">
          <h4>Order Summary</h4>
          <% if (cart && cart.products && cart.products.length > 0) { %>
            <ul class="list-group order-summary mb-3">
                <% cart.products.forEach((product) => { %>
                    <li class="list-group-item d-flex justify-content-between">
                        <div>
                            <h6 class="my-0"><%= product.productId.name %></h6>
                            <small class="text-muted">Quantity: <%= product.quantity %></small>
                        </div>
                        <span class="text-muted">₹<%= (product.productId.price * product.quantity).toFixed(2) %></span>
                    </li>
                <% }) %>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Total (INR)</span>
                    <strong id="totalPrice">₹<%= cart.products.reduce((acc, product) => acc + product.productId.price * product.quantity, 0).toFixed(2) %></strong>
                </li>
            </ul>
        <% } else { %>
            <p>No products found in cart.</p>
        <% } %>

          <button type="submit" class="btn btn-primary btn-lg btn-block mt-4">Place Order</button>
        </div>
      </div>
    </form>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    // JavaScript function to handle coupon application
    function applyCoupon(couponCode) {
        console.log('Applying coupon:', couponCode); // Debugging line
    
        $.post('/apply-coupon', { couponCode: couponCode }, function(data) {
            console.log('Response data:', data); // Debugging line
            
            // Update hidden inputs and UI with returned values
            $('#discountAmountInput').val(data.discountAmount);
            $('#finalAmountInput').val(data.finalAmount);
            $('#discountAmount').val(data.discountAmount);  // For placeOrderForm
            $('#finalAmount').val(data.finalAmount);        // For placeOrderForm
            $('#totalPrice').text('₹' + data.finalAmount.toFixed(2));
            
            alert(data.message); // Show the message from the response
        }).fail(function(response) {
            console.error('Failed response:', response); // Debugging line
            console.error('Error response JSON:', response.responseJSON); // Debugging line
            alert(response.responseJSON.message); // Make sure this path is correct
        });
    }
    
    // Attach the click event handler to the apply coupon buttons
    $(document).on('click', '.apply-coupon-button', function() {
        var couponCode = $(this).data('coupon-code');
        console.log('Coupon button clicked with code:', couponCode); // Debugging line
        applyCoupon(couponCode);
    });
    
    // Function to place the order
    function placeOrder() {
    const couponCode = $('#couponCodeInput').val();
    const discountAmount = parseFloat($('#discountAmountInput').val()) || 0;
    const finalAmount = parseFloat($('#finalAmountInput').val()) || 0;
    const paymentMethod = $('input[name="paymentMethod"]:checked').val();
    const shippingAddressId = $('input[name="shippingAddressId"]:checked').val();

    if (paymentMethod === 'wallet') {
        $.post('/place-order', { couponCode, discountAmount, finalAmount, paymentMethod, shippingAddressId }, function(data) {
            if (data.success) {
                alert(data.message);
                window.location.href = '/order-success';
            } else {
                alert(data.message);
            }
        }).fail(function(response) {
            alert(response.responseJSON.message);
        });
    } else {
        // Handle Razorpay or COD payments
        $('#razorpayButton').trigger('click');
    }
}

      // Razorpay payment integration
    $('#razorpayButton').click(function(e) {
    e.preventDefault();

    const form = document.getElementById('placeOrderForm');
    const formData = new FormData(form);

    const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
    const totalAmount = parseFloat($('#totalPrice').text().replace('₹', '')) || 0;
    const finalAmount = totalAmount - discountAmount;

    const options = {
        key: '<%= razorpayKeyId %>',
        amount: finalAmount * 100, // Convert to paise
        currency: 'INR',
        name: 'Your Shop Name',
        description: 'Order Payment',
        image: '/your_logo.png',
        handler: function (response) {
            formData.append('razorpayPaymentId', response.razorpay_payment_id);
            fetch('/complete-razorpay-payment', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Payment successful!');
                    window.location.href = '/order-success';
                } else {
                    alert('Payment failed!');
                }
            });
        },
        prefill: {
            name: '<%= user.firstName %> <%= user.lastName %>',
            email: '<%= user.email %>',
            contact: '<%= user.phone %>'
        },
        theme: {
            color: '#007bff'
        }
    };

    const rzp = new Razorpay(options);
    rzp.open();
});

    </script>    
</body>
</html>

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="/user_assets/css/main.css" />
  <style>
    body {
      font-family: "Arial", sans-serif;
      background-color: #f8f9fa;
      padding-top: 50px;
    }
    .container {
      max-width: 1200px;
    }
    .error-message {
      color: red;
    }
    .address-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      max-width: 400px;
    }
    .address-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .address-card.active {
      border-color: #007bff;
      background-color: #f1f9ff;
    }
    .address-actions {
      margin-top: 10px;
      text-align: right;
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .list-group-item {
      border: none;
      padding: 10px 0;
    }
    .order-summary .list-group-item {
      border-top: 1px solid #ddd;
      padding: 15px 0;
      max-width: 400px;
    }
    .btn-primary {
      background-color: #007bff;
      border: none;
      max-width: 300px;
    }
    .btn-primary:hover {
      background-color: #0056b3;
    }
    .header-nav {
      position: relative;
      margin-left: 250px;
    }
    .coupon-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
    }
    .coupon-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      transition: all 0.3s ease;
    }
    .coupon-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .coupon-info {
      flex: 1;
    }
    .coupon-code {
      font-size: 1rem;
      font-weight: bold;
      color: #333;
    }
    .coupon-discount {
      font-size: 0.9rem;
      color: #28a745;
    }
    .coupon-expiry {
      font-size: 0.8rem;
      color: #888;
    }
    .btn-outline-primary {
      font-size: 0.8rem;
      padding: 5px 10px;
    }
    .summary-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .content-section {
      flex: 1;
    }
    .checkout-row {
      display: flex;
    }
    .final-price-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="header-nav d-none d-lg-flex">
    <div class="main-menu main-menu-padding-1 main-menu-lh-2 d-none d-lg-block">
      <nav>
        <ul>
          <li>
            <a class="active" href="/">Home <i class="fi-rs-angle-down"></i></a>
            <ul class="sub-menu">
              <li><a href="index.html">Home 1</a></li>
              <li><a href="index-2.html">Home 2</a></li>
              <li><a href="index-3.html">Home 3</a></li>
              <li><a href="index-4.html">Home 4</a></li>
            </ul>
          </li>
          <li><a href="/shop">Shop</a></li>
          <li><a href="/cart">Cart</a></li>
        </ul>
      </nav>
    </div>
  </div>
  
  <div class="container">
    <h2 class="mb-4 text-center">Checkout</h2>

    <% if (message) { %>
    <div class="alert alert-<%= messageType %>"><%= message %></div>
    <% } %>

    <form id="placeOrderForm" action="/place-order" method="POST">
      <input type="hidden" name="discountAmount" id="discountAmount" value="0">
      <input type="hidden" name="couponCode" id="couponCodeInput" value="">
      <div class="checkout-row">
        <div class="content-section">
          <h4>Shipping Address</h4>
          <% if (user && user.addresses && user.addresses.length > 0) { %>
            <% user.addresses.forEach((address, index) => { %>
              <div class="address-card <%= index === 0 ? 'active' : '' %>">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="shippingAddressId"
                    id="address<%= index %>"
                    value="<%= address._id %>"
                    <%= index === 0 ? 'checked' : '' %> />
                  <label class="form-check-label" for="address<%= index %>">
                    <%= address.firstName %> <%= address.lastName %><br />
                    <%= address.address1 %> <%= address.address2 %><br />
                    <%= address.city %>, <%= address.state %> <%= address.zip %><br />
                    <%= address.phone %><br />
                    <%= address.email %>
                  </label>
                </div>
                <div class="address-actions">
                  <a href="/profile/edit-address/<%= address._id %>" class="btn btn-secondary btn-sm">Edit</a>
                </div>
              </div>
            <% }) %>
            <a href="/profile/add-addressPage" class="btn btn-primary mt-3">Add Address</a>
          <% } else { %>
            <p>No addresses found.</p>
            <a href="/profile/add-addressPage" class="btn btn-primary">Add Address</a>
          <% } %>

          <h4 class="mt-4">Payment Method</h4>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="wallet" value="wallet" />
            <label class="form-check-label" for="wallet">Wallet</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="razorpay" value="Razorpay" />
            <label class="form-check-label" for="razorpay">Razorpay</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="Cash on Delivery" />
            <label class="form-check-label" for="cashOnDelivery">Cash on Delivery</label>
          </div>

          <button type="button" class="btn btn-primary btn-lg btn-block mt-4" id="razorpayButton">Pay with Razorpay</button>
          <button type="submit" class="btn btn-primary btn-lg btn-block mt-4" id="placeOrderButton">Place Order</button>
        </div>

        <div class="summary-section">
          <h4>Order Summary</h4>
          <% if (cart && cart.products && cart.products.length > 0) { %>
            <ul class="list-group order-summary mb-3">
              <% cart.products.forEach((product) => { %>
                <li class="list-group-item d-flex justify-content-between">
                  <div>
                    <h6 class="my-0"><%= product.productId.name %></h6>
                    <small class="text-muted">Quantity: <%= product.quantity %></small>
                  </div>
                  <span class="text-muted">₹<%= (product.productId.price * product.quantity).toFixed(2) %></span>
                </li>
              <% }) %>
              <li class="list-group-item d-flex justify-content-between">
                <span>Total (INR)</span>
                <strong>₹<%= cart.products.reduce((acc, product) => acc + (product.productId.price * product.quantity), 0).toFixed(2) %></strong>
              </li>
            </ul>
          <% } else { %>
            <p>Your cart is empty.</p>
          <% } %>

          <div class="coupon-container">
            <h5>Apply Coupon</h5>
            <% if (coupons && coupons.length > 0) { %>
              <% coupons.forEach((coupon) => { 
                const expiryDate = coupon.endDate ? new Date(coupon.endDate).toLocaleDateString() : 'No Expiry';
                const discountDisplay = coupon.discountType === 'percentage' 
                                        ? `${coupon.discountValue}%` 
                                        : `₹${coupon.discountValue}`;
                const discountAmount = coupon.discountType === 'percentage'
                                        ? (cart.totalAmount * coupon.discountValue) / 100
                                        : coupon.discountValue;
                const finalPriceAfterDiscount = cart.totalAmount - discountAmount;
              %>
                <div class="coupon-item">
                  <div class="coupon-info">
                    <span class="coupon-code"><%= coupon.code %></span>
                    <p class="coupon-discount">
                      Discount: <%= discountDisplay %>
                    </p>
                    <p class="coupon-expiry">Expiry: <%= expiryDate %></p>
                  </div>
                  <button type="button" class="btn btn-outline-primary apply-coupon-btn" 
                    data-code="<%= coupon.code %>"
                    data-discount-amount="<%= discountAmount %>"
                    data-final-price-after-discount="<%= finalPriceAfterDiscount.toFixed(2) %>">
                    Apply Coupon
                  </button>
                </div>
              <% }) %>
            <% } else { %>
              <p>No coupons available at the moment.</p>
            <% } %>
          </div>
          
          <div class="price-summary">
            <p class="final-price">Final Price Before Discount: ₹<%= totalAmount.toFixed(2) %></p>
            <% if (discountAmount > 0) { %>
              <p class="discount-amount">Discount: ₹<%= discountAmount.toFixed(2) %></p>
            <% } %>
            <p class="final-price">Final Price: ₹<%= finalAmount.toFixed(2) %></p>
          </div>
          
          
          
          
      </div>
    </form>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    $(document).ready(function () {
  const applyCouponBtns = document.querySelectorAll('.apply-coupon-btn');
  
  applyCouponBtns.forEach(button => {
    button.addEventListener('click', function () {
      const couponCode = this.getAttribute('data-code');
      const discountAmount = parseFloat(this.getAttribute('data-discount-amount'));
      const finalPriceAfterDiscount = parseFloat(this.getAttribute('data-final-price-after-discount'));

      // Update the discount amount and coupon code
      document.getElementById('discountAmount').textContent = `₹${discountAmount.toFixed(2)}`;
      document.getElementById('couponCodeInput').value = couponCode;

      // Update the final price display
      $('.final-price-value').text(`₹${finalPriceAfterDiscount.toFixed(2)}`);
    });
  });

  $('#razorpayButton').click(function (e) {
    e.preventDefault();

    const options = {
      key: "<%= razorpayKeyId %>",
      amount: parseFloat($('#finalAmount').val()) * 100, // Razorpay expects amount in paise
      currency: "INR",
      name: "Your Store",
      description: "Test Transaction",
      handler: function (response) {
        $.ajax({
          method: 'POST',
          url: '/verify-payment',
          data: {
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature
          },
          success: function (data) {
            alert('Payment Successful');
            // Optionally, redirect to success page
          },
          error: function (error) {
            alert('Payment Failed');
          }
        });
      },
      prefill: {
        name: "<%= user.name %>",
        email: "<%= user.email %>",
        contact: "<%= user.phone %>"
      },
      theme: {
        color: "#3399cc"
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  });
});

  </script>
</body>
</html>











 -->

 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="/user_assets/css/main.css" />
  <!-- Adjust the path as needed -->
  <style>
    body {
      font-family: "Arial", sans-serif;
      background-color: #f8f9fa;
      padding-top: 50px;
    }
    .container {
      max-width: 1200px;
    }
    .error-message {
      color: red;
    }
    .address-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      max-width: 400px;
    }
    .address-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .address-card.active {
      border-color: #007bff;
      background-color: #f1f9ff;
    }
    .address-actions {
      margin-top: 10px;
      text-align: right;
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .list-group-item {
      border: none;
      padding: 10px 0;
    }
    .order-summary .list-group-item {
      border-top: 1px solid #ddd;
      padding: 15px 0;
      max-width: 400px;
    }
    .btn-primary {
      background-color: #007bff;
      border: none;
      max-width: 300px;
    }
    .btn-primary:hover {
      background-color: #0056b3;
    }
    .header-nav {
      position: relative;
      margin-left: 250px;
    }
    /* Styling for coupon section */
    .coupon-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
    }
    .coupon-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      transition: all 0.3s ease;
    }
    .coupon-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .coupon-info {
      flex: 1;
    }
    .coupon-code {
      font-size: 1rem;
      font-weight: bold;
      color: #333;
    }
    .coupon-discount {
      font-size: 0.9rem;
      color: #28a745;
    }
    .coupon-expiry {
      font-size: 0.8rem;
      color: #888;
    }
    .btn-outline-primary {
      font-size: 0.8rem;
      padding: 5px 10px;
    }
    .summary-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .content-section {
      flex: 1;
    }
    .checkout-row {
      display: flex;
    }
  </style>
</head>
<body>
  <!-- navbar -->
  <div class="header-nav d-none d-lg-flex">
    <div class="main-menu main-menu-padding-1 main-menu-lh-2 d-none d-lg-block">
      <nav>
        <ul>
          <li>
            <a class="active" href="/">Home <i class="fi-rs-angle-down"></i></a>
            <ul class="sub-menu">
              <li><a href="index.html">Home 1</a></li>
              <li><a href="index-2.html">Home 2</a></li>
              <li><a href="index-3.html">Home 3</a></li>
              <li><a href="index-4.html">Home 4</a></li>
            </ul>
          </li>
          <li><a href="/shop">Shop</a></li>
          <li><a href="/cart">Cart</a></li>
        </ul>
      </nav>
    </div>
  </div>
  <!-- navbar ends -->
  <div class="container">
    <h2 class="mb-4 text-center">Checkout</h2>
  
    <% if (message) { %>
    <div class="alert alert-<%= messageType %>"><%= message %></div>
    <% } %>
  
    <form id="placeOrderForm" action="/place-order" method="POST">
      <input type="hidden" name="discountAmount" id="discountAmount" value="0">
      <input type="hidden" name="couponCode" id="couponCodeInput" value="">
      <div class="checkout-row">
        <div class="content-section">
          <h4>Shipping Address</h4>
          <% if (user && user.addresses && user.addresses.length > 0) { %>
            <% user.addresses.forEach((address, index) => { %>
              <div class="address-card <%= index === 0 ? 'active' : '' %>">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="shippingAddressId"
                    id="address<%= index %>"
                    value="<%= address._id %>"
                    <%= index === 0 ? 'checked' : '' %>
                  />
                  <label class="form-check-label" for="address<%= index %>">
                    <%= address.firstName %> <%= address.lastName %><br />
                    <%= address.address1 %> <%= address.address2 %><br />
                    <%= address.city %>, <%= address.state %> <%= address.zip %><br />
                    <%= address.phone %><br />
                    <%= address.email %>
                  </label>
                </div>
                <div class="address-actions">
                  <a href="/profile/edit-address/<%= address._id %>" class="btn btn-secondary btn-sm">Edit</a>
                </div>
              </div>
            <% }) %>
            <a href="/profile/add-addressPage" class="btn btn-primary mt-3">Add Address</a>
          <% } else { %>
            <p>No addresses found.</p>
            <a href="/profile/add-addressPage" class="btn btn-primary">Add Address</a>
          <% } %>
      
          <h4 class="mt-4">Payment Method</h4>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="wallet" value="wallet" />
            <label class="form-check-label" for="wallet">Wallet</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="razorpay" value="Razorpay" />
            <label class="form-check-label" for="razorpay">Razorpay</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="Cash on Delivery" />
            <label class="form-check-label" for="cashOnDelivery">Cash on Delivery</label>
          </div>

          <!-- Razorpay Button -->
          <button type="button" class="btn btn-primary btn-lg btn-block mt-4" id="razorpayButton">Pay with Razorpay</button>
        </div>
  
        <div class="summary-section">
          <h4>Order Summary</h4>
          <% if (cart && cart.products && cart.products.length > 0) { %>
            <ul class="list-group order-summary mb-3">
              <% cart.products.forEach((product) => { %>
                <li class="list-group-item d-flex justify-content-between">
                  <div>
                    <h6 class="my-0"><%= product.productId.name %></h6>
                    <small class="text-muted">Quantity: <%= product.quantity %></small>
                  </div>
                  <span class="text-muted">₹<%= (product.productId.price * product.quantity).toFixed(2) %></span>
                </li>
              <% }) %>
              <li class="list-group-item d-flex justify-content-between">
                <span>Total (INR)</span>
                <strong>₹<%= cart.products.reduce((acc, product) => acc + product.productId.price * product.quantity, 0).toFixed(2) %></strong>
              </li>
            </ul>
          <% } else { %>
            <p>No products found in cart.</p>
          <% } %>
  
          <!-- Coupon Application Section -->
          <div class="coupon-container">
            <h5>Apply Coupon</h5>
            <% if (coupons && coupons.length > 0) { %>
              <% coupons.forEach((coupon) => { %>
                <div class="coupon-item">
                  <div class="coupon-info">
                    <div class="coupon-code"><%= coupon.code %></div>
                    <div class="coupon-discount">Discount: <%= coupon.discountPercentage ? coupon.discountPercentage + '%' : coupon.discountAmount ? '₹' + coupon.discountAmount : '' %></div>
                    <div class="coupon-expiry">Expires on: <%= coupon.expirationDate.toLocaleDateString() %></div>
                  </div>
                  <button type="button" class="btn btn-outline-primary apply-coupon" data-code="<%= coupon.code %>" data-discount="<%= coupon.discountPercentage || coupon.discountAmount %>" data-type="<%= coupon.discountPercentage ? 'percentage' : 'fixed' %>">Apply</button>
                </div>
              <% }) %>
            <% } else { %>
              <p>No coupons available.</p>
            <% } %>
          </div>

          <!-- Final Price Section -->
          <div class="final-price-value">
            ₹<span id="finalPriceValue">
              <% if (cart && cart.products && cart.products.length > 0) { %>
                <%= cart.products.reduce((acc, product) => acc + product.productId.price * product.quantity, 0).toFixed(2) %>
              <% } else { %>
                0.00
              <% } %>
            </span>
          </div>
          
        
        </div>
      </div>
  
      <!-- Add a submit button for order placement -->
      <button type="submit" class="btn btn-primary btn-lg btn-block mt-4" id="placeOrderButton">Place Order</button>
    </form>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    $(document).ready(function () {
      // Handle applying a coupon
      $('.apply-coupon').on('click', function () {
        var couponCode = $(this).data('code');
        var discountPercentage = $(this).data('discount');
        var originalPrice = parseFloat($('#finalPriceValue').text());
        var discountAmount = (originalPrice * discountPercentage) / 100;
        var finalPrice = originalPrice - discountAmount;

        $('#discountAmount').val(discountAmount.toFixed(2));
        $('#finalPriceValue').text(finalPrice.toFixed(2));
        $('#couponCodeInput').val(couponCode);
      });

   // Razorpay payment
   $('#razorpayButton').click(function (e) {
            e.preventDefault(); // Prevent form from submitting

            const totalAmount = parseFloat($('#discountAmount').text()) * 100; // Convert to paise

            const options = {
                "key": "<%= razorpayKeyId %>", // Razorpay Key ID passed from backend
                "amount": totalAmount,
                "currency": "INR",
                "name": "Your Site Name",
                "description": "Test Transaction",
                "order_id": "<%= razorpayOrderId %>", // Razorpay Order ID passed from backend
                "handler": function (response) {
                    // After successful payment
                    alert('Payment successful with Razorpay ID: ' + response.razorpay_payment_id);

                    // Append payment details to the form
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'razorpay_order_id',
                        value: response.razorpay_order_id
                    }).appendTo('#placeOrderForm');

                    $('<input>').attr({
                        type: 'hidden',
                        name: 'razorpay_payment_id',
                        value: response.razorpay_payment_id
                    }).appendTo('#placeOrderForm');

                    $('<input>').attr({
                        type: 'hidden',
                        name: 'razorpay_signature',
                        value: response.razorpay_signature
                    }).appendTo('#placeOrderForm');

                    // Manually set payment method
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'paymentMethod',
                        value: 'Razorpay'
                    }).appendTo('#placeOrderForm');

                    // Submit the form to place the order
                    $('#placeOrderForm').submit(); 
                },
                "prefill": {
                    "name": "<%= user.firstName %> <%= user.lastName %>",
                    "email": "<%= user.email %>",
                    "contact": "<%= user.phone %>"
                }
            };

            const rzp1 = new Razorpay(options);
            rzp1.open();
        });
});
  </script>
</body>
</html>
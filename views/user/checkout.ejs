<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">  

    <style>
        .error-message {
            color: red;
        }
        .address-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .address-card.active {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .address-actions {
            margin-top: 10px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Checkout</h2>

        <% if (message) { %>
            <div class="alert alert-<%= messageType %>">
                <%= message %>
            </div>
        <% } %>

        <form action="/place-order" method="POST">
            <div class="row">
                <div class="col-md-8">
                    <h4>Shipping Address</h4>
                    <% if (user && user.addresses && user.addresses.length > 0) { %>
                        <% user.addresses.forEach((address, index) => { %>
                            <div class="address-card <%= index === 0 ? 'active' : '' %>">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="shippingAddressId" id="address<%= index %>" value="<%= address._id %>" <%= index === 0 ? 'checked' : '' %>>
                                    <label class="form-check-label" for="address<%= index %>">
                                        <%= address.firstName %> <%= address.lastName %><br>
                                        <%= address.address1 %> <%= address.address2 %><br>
                                        <%= address.city %>, <%= address.state %> <%= address.zip %><br>
                                        <%= address.phone %><br>
                                        <%= address.email %>
                                    </label>
                                </div>
                                <div class="address-actions">
                                    <a href="/profile/edit-address/<%= address._id %>" class="btn btn-primary btn-sm">Edit</a>
                                    <form action="/profile/delete-address/<%= address._id %>" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </div>
                                
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>No addresses found. Please add an address in your profile.</p>
                    <% } %>
                    <button type="button" class="btn btn-secondary btn-sm mt-2" id="add-address">Add Address</button>

                    <h4>Payment Method</h4>
                    <div class="form-group">
                        <select class="form-control" name="paymentMethod" required>
                            <option value="Credit Card">Credit Card</option>
                            <option value="PayPal">PayPal</option>
                            <option value="Cash on Delivery">Cash on Delivery</option>
                        </select>
                    </div>

                    <h4>Order Notes</h4>
                    <div class="form-group">
                        <textarea class="form-control" name="orderNotes" rows="3"></textarea>
                    </div>
                </div>

                <div class="col-md-4">
                    <h4>Order Summary</h4>
                    <% if (cart && cart.products && cart.products.length > 0) { %>
                        <ul class="list-group mb-3">
                            <% cart.products.forEach(product => { %>
                                <li class="list-group-item d-flex justify-content-between lh-condensed">
                                    <div>
                                        <h6 class="my-0"><%= product.productId.name %></h6>
                                        <small class="text-muted">Quantity: <%= product.quantity %></small>
                                    </div>
                                    <span class="text-muted">$<%= (product.productId.price * product.quantity).toFixed(2) %></span>
                                </li>
                            <% }) %>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total (USD)</span>
                                <strong>$<%= cart.products.reduce((total, product) => total + (product.productId.price * product.quantity), 0).toFixed(2) %></strong>
                            </li>
                        </ul>
                    <% } else { %>
                        <p>Your cart is empty.</p>
                    <% } %>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg btn-block mt-4">Place Order</button>
        </form>
    </div>

    <!-- Add Address Modal -->
    <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
                        <div class="form-group">
                            <label for="firstName">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" required>
                        </div>
                        <div class="form-group">
                            <label for="companyName">Company Name</label>
                            <input type="text" class="form-control" id="companyName" name="companyName">
                        </div>
                        <div class="form-group">
                            <label for="address1">Address Line 1</label>
                            <input type="text" class="form-control" id="address1" name="address1" required>
                        </div>
                        <div class="form-group">
                            <label for="address2">Address Line 2</label>
                            <input type="text" class="form-control" id="address2" name="address2">
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" class="form-control" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" class="form-control" id="state" name="state" required>
                        </div>
                        <div class="form-group">
                            <label for="zip">Zip Code</label>
                            <input type="text" class="form-control" id="zip" name="zip" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Address</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/path/to/jquery.js"></script>
    <script src="/path/to/bootstrap.js"></script>
    <script>
        $(document).ready(function() {
            // Highlight the selected address card
            $('input[name="shippingAddressId"]').on('change', function() {
                $('.address-card').removeClass('active');
                $(this).closest('.address-card').addClass('active');
            });

            // Show Add Address Modal
            $('#add-address').on('click', function() {
                $('#addAddressModal').modal('show');
            });

            // Handle the Add Address form submission
            $('#addressForm').on('submit', function(e) {
                e.preventDefault();
                const formData = $(this).serialize();
                
                // Send the form data to the server
                $.post('/addAddress', formData, function(data) {
                    if (data.success) {
                        // Reload the page to show the new address
                        location.reload();
                    } else {
                        alert('Error adding address. Please try again.');
                    }
                });
            });

            // Handle Edit Address button click
            $('.edit-address').on('click', function() {
                const addressId = $(this).data('id');
                // Open edit address modal and populate with current address details
                // You need to implement a modal similar to Add Address Modal
                // Fetch current address details using AJAX
                $.get('/getAddress/' + addressId, function(data) {
                    if (data.success) {
                        // Populate the edit address modal with current address details
                        // Open the edit address modal
                        $('#editAddressModal').modal('show');
                    } else {
                        alert('Error fetching address details. Please try again.');
                    }
                });
            });

            // Handle Delete Address button click
            $('.delete-address').on('click', function() {
                const addressId = $(this).data('id');
                if (confirm('Are you sure you want to delete this address?')) {
                    $.post('/deleteAddress', { addressId: addressId }, function(data) {
                        if (data.success) {
                            // Reload the page to update the address list
                            location.reload();
                        } else {
                            alert('Error deleting address. Please try again.');
                        }
                    });
                }
            });
        });
        
    </script>
</body>
</html>
